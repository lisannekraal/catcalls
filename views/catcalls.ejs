
<%- include("partials/header") %>


    <div class='sidebar'>
        <div class='heading'>
            <h4 class="sidebarHeader">Browse all catcalls <i class="far fa-arrow-alt-circle-down"></i></h4> 
        </div>
        <div id='listings' class='listings'>
        </div>
    </div>

    <div id='map' class='map pad2'>Map</div>
    <div id="map-overlay-button">
        <a href="/new"><i class="fas fa-plus-square fa-3x"></i></a>
    </div>

    <script>
    // This will let you use the .remove() function later on
    if (!('remove' in Element.prototype)) {
        Element.prototype.remove = function() {
            if (this.parentNode) {
            this.parentNode.removeChild(this);
            }
        };
    }

    mapboxgl.accessToken = 'pk.eyJ1IjoibGlzYW4ta3JhYWwiLCJhIjoiY2s1Mm9uaXN4MDBiczNubHM2ZXc3MWIwaSJ9.6zWdzChRs2uXgoUUWJZZPw';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [4.908019, 52.366249],
        zoom: 12
    });

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    const catcallsData = '<%- catcalls %>';
    const catcalls = JSON.parse(catcallsData);

    var geojson = {
      type: 'FeatureCollection',
      features: catcalls
    };

    geojson.features.forEach(function(catcall, i){
        catcall.properties.id = i;
    });

    function buildCatcallList(geojson) {
        geojson.features.forEach(function(catcall, i){
            var prop = catcall.properties;

            // Add a new listing section to the sidebar
            var listings = document.getElementById('listings');
            var listing = listings.appendChild(document.createElement('div'));
            listing.id = "listing-" + prop.id;
            listing.className = 'item';

            // Add the link to the individual listing created above
            const link = listing.appendChild(document.createElement('a'));
            link.href = '#';
            link.className = 'title';
            link.id = prop.id; //used to be link.id = "link-" + prop.id;
            link.innerHTML = '"' + prop.description + '"';

            //////////////////////////onderstaande allemaal geprobeerd maar kan misschien wel weg?

            // const mongoDBdata = prop.img.data;
            // var canvas = document.createElement("canvas");
            // var ctx = canvas.getContext("2d");
            // var data = ctx.putImageData(mongoDBdata,0,0);

            // var image = new Image();
            // image.id = "rendered-picture"
            // image.src = canvas.toDataURL();
            // console.log(image);
            // listing.appendChild(image);

            //const image = listing.appendChild(document.createElement('img'));
            //image.width = "20";
            //image.height = "20";
            //image.src = prop.img.data;

            ///////////////////////

            // Add details to the individual listing --> not needed because we show this in the popup
            // var details = listing.appendChild(document.createElement('div'));
            // details.innerHTML = prop.date;
            // if (prop.context) {
            // details.innerHTML += ' · ' + prop.context;
            // }

            link.addEventListener('click', function(e){

              var clickedListing = geojson.features[this.id];
              flyToLocation(clickedListing);
              createPopUp(clickedListing);

              var activeItem = document.getElementsByClassName('active');
              if (activeItem[0]) {
                activeItem[0].classList.remove('active');
              }
              this.parentNode.classList.add('active');
            });
        });
    }

    function addMarkers() {
      geojson.features.forEach(function(marker) {
        var el = document.createElement('div');
        el.id = "marker-" + marker.properties.id;
        el.className = 'marker';
        
        new mapboxgl.Marker(el, { offset: [0, -23] })
          .setLngLat(marker.geometry.coordinates)
          .addTo(map);
        
          el.addEventListener('click', function(e){
            flyToLocation(marker);
            createPopUp(marker);

            var activeItem = document.getElementsByClassName('active');
            e.stopPropagation();
            if (activeItem[0]) {
              activeItem[0].classList.remove('active');
            }
            var listing = document.getElementById('listing-' + marker.properties.id);
            listing.classList.add('active');
          });
      });
    }

    map.on('load', function (e) {
        map.addSource('locations', {
          type: 'geojson',
          data: geojson
        });
        addMarkers();
        buildCatcallList(geojson);
    });

    function flyToLocation(currentFeature) {
        map.flyTo({
            center: currentFeature.geometry.coordinates,
            zoom: 15
        });
    }

    function createPopUp(currentFeature) {
        var popUps = document.getElementsByClassName('mapboxgl-popup');
        // Check if there is already a popup on the map and if so, remove it
        if (popUps[0]) popUps[0].remove();

        //edit standard date-format into dutch version or display 'without date'
        let date = currentFeature.properties.date;
        console.log(date);
        let dateDisplay;
        if(date == "zonder datum"){
            dateDisplay = "zonder datum";
        } else {
            const dateArray = currentFeature.properties.date.split("-");
            dateDisplay = dateArray[2] + "-" + dateArray[1] + "-" + dateArray[0];
        }

        var popup = new mapboxgl.Popup({ closeOnClick: false })
            .setLngLat(currentFeature.geometry.coordinates)
            .setHTML('<h5>CATCALL</h5>' +
            '<h3>"' + currentFeature.properties.description + '"</h3>' +
            '<p>' + dateDisplay + ' · ' + currentFeature.properties.context + '</p>')
            .addTo(map);
    }

    </script>
 
<%- include("partials/footer") %>




